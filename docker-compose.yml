services:
  eth-node:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: bridge-eth-node
    platform: linux/arm64
    environment:
      - ANVIL_IP_ADDR=0.0.0.0
    command: ["anvil", "--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://localhost:8545 >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - bridge-network

  eth-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: bridge-eth-deployer
    platform: linux/arm64
    user: root
    working_dir: /workspace
    volumes:
      - ./contracts/evm:/workspace
      - eth-deployments:/deployments
    environment:
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - ETH_RPC_URL=http://eth-node:8545
      - FOUNDRY_DISABLE_NIGHTLY_WARNING=1
    entrypoint: []
    command:
      - sh
      - -c
      - |
        set -e
        
        if [ ! -f "script/deploy_bridge.s.sol" ]; then
          echo "ERROR: Deploy script not found"
          exit 1
        fi
        
        forge script script/deploy_bridge.s.sol \
          --rpc-url $$ETH_RPC_URL \
          --private-key $$PRIVATE_KEY \
          --broadcast \
          --legacy \
          -vvv 2>&1 | tee /tmp/forge_output.log
        
        # Extract deployment info from forge output (no JSON parsing needed)
        echo "Extracting deployment info..."
        
        # Base config
        echo "NETWORK=Anvil Local Network" > /deployments/deployment.txt
        echo "CHAIN_ID=31337" >> /deployments/deployment.txt
        echo "RPC_URL=http://localhost:8545" >> /deployments/deployment.txt
        echo "DEPLOYER=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" >> /deployments/deployment.txt
        echo "PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" >> /deployments/deployment.txt
        echo "" >> /deployments/deployment.txt
        
        # Extract contracts from forge output (clean format)
        grep "\\[Deployed\\]" /tmp/forge_output.log | sed -E 's/^[[:space:]]*\\[Deployed\\] ([^:]+): (0x[a-fA-F0-9]+).*$$/\\1=\\2/' >> /deployments/deployment.txt
        
        # Get proxy address
        PROXY=$$(grep "\\[Deployed\\] SuiBridge:" /tmp/forge_output.log | grep -o '0x[a-fA-F0-9]*' | head -1)
        [ -z "$$PROXY" ] && PROXY="0x0000000000000000000000000000000000000000"
        
        echo "ERC1967Proxy=$$PROXY" >> /deployments/deployment.txt
        
        # Minimal JSON for compatibility
        echo "{\"contracts\":{\"ERC1967Proxy\":\"$$PROXY\"}}" > /deployments/deployment.json
        
        echo "=== Deployment Complete ==="
        cat /deployments/deployment.txt
        echo "==========================="
    depends_on:
      eth-node:
        condition: service_healthy
    networks:
      - bridge-network
    restart: "no"

  deployment-info:
    image: nginx:alpine
    container_name: bridge-deployment-info
    ports:
      - "8080:80"
    volumes:
      - eth-deployments:/usr/share/nginx/html:ro
    depends_on:
      - eth-deployer
    networks:
      - bridge-network
    restart: unless-stopped

volumes:
  eth-deployments:
    name: bridge-eth-deployments

networks:
  bridge-network:
    name: bridge-network
    driver: bridge
