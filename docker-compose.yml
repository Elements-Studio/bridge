services:
  eth-node:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: bridge-eth-node
    platform: linux/arm64
    environment:
      - ANVIL_IP_ADDR=0.0.0.0
    command: ["anvil", "--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337", "--block-time", "2"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://localhost:8545 >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - bridge-network

  eth-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: bridge-eth-deployer
    platform: linux/arm64
    user: root
    working_dir: /workspace
    volumes:
      - ./contracts/evm:/workspace
      - eth-deployments:/deployments
    environment:
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - ETH_RPC_URL=http://eth-node:8545
      - FOUNDRY_DISABLE_NIGHTLY_WARNING=1
    entrypoint: []
    command:
      - sh
      - -c
      - |
        set -e
        
        if [ ! -f "script/deploy_bridge.s.sol" ]; then
          echo "ERROR: Deploy script not found"
          exit 1
        fi
        
        forge script script/deploy_bridge.s.sol \
          --rpc-url $$ETH_RPC_URL \
          --private-key $$PRIVATE_KEY \
          --broadcast \
          --legacy \
          --slow \
          -vvv
        
        if [ $$? -eq 0 ] && [ -f "broadcast/deploy_bridge.s.sol/31337/run-latest.json" ]; then
          if ! command -v jq >/dev/null 2>&1; then
            apt-get update -qq && apt-get install -y -qq jq > /dev/null 2>&1
          fi
          
          cat broadcast/deploy_bridge.s.sol/31337/run-latest.json | jq '{
            network: {
              name: "Anvil Local Network",
              chainId: 31337,
              rpcUrl: "http://localhost:8545"
            },
            deployment: {
              timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              deployer: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
            },
            contracts: ([.transactions[] | select(.transactionType == "CREATE" and .contractAddress != null) | {(.contractName): .contractAddress}] | add),
            accounts: {
              default: {
                address: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                privateKey: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
                balance: "10000 ETH"
              }
            }
          }' > /deployments/deployment.json
          
          echo "Deployment info saved to /deployments/deployment.json"
        fi
    depends_on:
      eth-node:
        condition: service_healthy
    networks:
      - bridge-network
    restart: "no"

  deployment-info:
    image: nginx:alpine
    container_name: bridge-deployment-info
    ports:
      - "8080:80"
    volumes:
      - eth-deployments:/usr/share/nginx/html:ro
    depends_on:
      - eth-deployer
    networks:
      - bridge-network
    restart: unless-stopped

volumes:
  eth-deployments:
    name: bridge-eth-deployments

networks:
  bridge-network:
    name: bridge-network
    driver: bridge
